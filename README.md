# Avito backend assigment 
## Запуск
```shell
make docker-up
```

Сервис запускается на адресе http://localhost:8085

Swagger документация доступна по адресу http://localhost:8085/swagger/index.html

## Make file
В make файле достуны следующие команды
- ```build``` - сборка сервиса
- ```gen-swagger``` - генерайия Swagger документации
- ```docker-up``` - запуск контейнера
- ```gen-mock``` - генерация моков
- ```test``` - запуск юнит и интеграционных тестов
- ```test-ci``` - запуск юнит тестов

## Детали
- При удалении сегмента автоматически удаляются все записи, которые связывают этот сегмент с конкретными пользователями.


- Если пытаться удалить несуществующий сегмент либо сегмент, который не назначеный пользователю, то сервис выдаст сообщение об ошибке.


- Добавление и удаление сегментов для пользователя осуществляется в рамках одной транзакции. Если при выполнении какого-либо действия возникнет ошибка, то все предыдущие шаги этой транзакции будут отменены (откат назад).


- При запросе сегментов конкретного пользователя, система вернёт только те сегменты, срок действия которых ещё не истёк на текущий момент. То есть срок годности сегментов должен быть позднее текущей даты и времени.
### Примеры запросов
#### Добавление и удаление сегментов у пользователя
    curl -X 'PUT' \
        'http://localhost:8085/addDeleteUserSegment' \
        -H 'accept: application/json' \
        -H 'Content-Type: application/json' \
        -d '{
            "to_add": [
                {
                    "expires": "2023-08-25T17:00:05",
                    "name": "SEGMENT10"
                }
            ],
            "to_delete": [
                "SEGMENT1",
                "SEGMENT2"
            ],
            "user_id": 1000
        }'
###### Ответ при успешном выполнении
    {
        "added_ids": [
            1
        ]
    }
#### Получение сегментов пользователя
    curl -X 'GET' \
      'http://localhost:8085/getSegmentsOfUser/1000'
###### Ответ при успешном выполнении
    {
        "segments": [
            {
                "name": "SEGMENT101",
                "expires": "2023-09-25T17:00:05"
            }
        ]
    }

#### Добавление сегмента
    curl -X 'POST' \
      'http://localhost:8085/addSegment' \
      -H 'accept: application/json' \
      -H 'Content-Type: application/json' \
      -d '{
      "name": "AVITO_TEST_SEGMENT"
    }'

#### Удаление сегмента
    curl -X 'DELETE' \
      'http://localhost:8085/deleteSegment?name=SOME_SEGMENT_NAME' 

###### Ответ при успешном выполнении
    {
        "id": 135
    }

#### Удаление просроченных назначений сегментов
    curl -X 'DELETE' \
    'http://localhost:8085/flushExpired'

